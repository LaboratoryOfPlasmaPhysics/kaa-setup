- name: Install JupyterHub dependencies
  package:
    name: [python3-virtualenv.noarch, npm]
    state: present

- name: Add the user jupyter
  ansible.builtin.user:
    name: jupyter
    shell: /bin/bash
    groups: docker

- name: Create virtualenv folder
  ansible.builtin.file:
    path: /opt/virtual-envs
    state: directory
    mode: '0755'
    recurse: yes
    owner: jupyter
    group: jupyter

- name: Create user global dir for npm install
  ansible.builtin.file:
    path: $HOME/.npm-packages
    state: directory
    mode: '0755'
    recurse: yes
    owner: jupyter
    group: jupyter
  register: npm_dir

- name: "Configure npm to use {{ home }}/.npm-packages"
  shell: "npm config set prefix $HOME/.npm-packages"
  when: npm_dir.changed
  become: yes
  become_user: jupyter

- name: Create JupyterHub venv
  pip:
    name: [jupyterhub, dockerspawner ]
    virtualenv: /opt/virtual-envs/hub
    virtualenv_command: virtualenv
  become: yes
  become_user: jupyter

- name: Install JupyterHub sshauthenticator
  pip:
    name:  'https://github.com/andreas-h/sshauthenticator/archive/v0.1.zip'
    virtualenv: /opt/virtual-envs/hub
    virtualenv_command: virtualenv
  become: yes
  become_user: jupyter

- name: Install "configurable-http-proxy" node.js package globally.
  community.general.npm:
    name: configurable-http-proxy
    global: yes
  become: yes
  become_user: jupyter

- name: install hub config file
  template:
    src: jupyterhub_config.py.j2
    dest: $HOME/jupyterhub_config.py
    owner: jupyter
    group: jupyter
    mode: '0644'
  become: yes
  become_user: jupyter

- name: JupyterHub service Unit file
  copy:
    dest: "/etc/systemd/system/jupyterhub.service"
    content: |
      [Unit]
      Description=LPP jupyterhub server
      After=network.target
      StartLimitIntervalSec=0
      [Service]
      Type=simple
      Restart=always
      User=jupyter
      WorkingDirectory=/home/jupyter
      Environment=PATH=/home/jupyter/.npm-packages/bin/:/home/jupyter/.local/bin:/home/jupyter/bin:/root/.local/bin:/root/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/var/lib/snapd/snap/bin
      ExecStart=/opt/virtual-envs/hub/bin/jupyterhub
      [Install]
      WantedBy=multi-user.target

- name: Enable and start JupyterHub
  systemd:
    name: jupyterhub
    daemon_reload: yes
    state: restarted
    enabled: yes